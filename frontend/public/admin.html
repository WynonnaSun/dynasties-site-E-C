<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin - Email Records</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 24px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
    .loading { text-align: center; padding: 20px; }
    .error { color: red; padding: 20px; }
    .message-cell { max-width: 300px; word-wrap: break-word; }
  </style>
</head>
<body>
  <h2>Email Submissions</h2>
  <div id="content">
    <div class="loading">Loading...</div>
  </div>

  <table id="dataTable" style="display: none;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Message</th>
        <th>Created At</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- 加载配置 -->
  <script src="/config.js"></script>
  
  <script>
    const API_BASE_URL = window.APP_CONFIG?.API_URL || 'http://localhost:8000';
    
    const username = prompt("Admin username:");
    const password = prompt("Admin password:");

    if (!username || !password) {
      document.getElementById('content').innerHTML = '<div class="error">Authentication required</div>';
    } else {
      const auth = btoa(`${username}:${password}`);

      fetch(`${API_BASE_URL}/api/admin/emails`, {
        headers: {
          "Authorization": `Basic ${auth}`
        }
      })
        .then(res => {
          if (!res.ok) {
            throw new Error("Unauthorized");
          }
          return res.json();
        })
        .then(data => {
          document.getElementById('content').style.display = 'none';
          document.getElementById('dataTable').style.display = 'table';
          
          const tbody = document.getElementById("tbody");
          
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No records found</td></tr>';
          } else {
            data.forEach(row => {
              const tr = document.createElement("tr");
              const date = new Date(row.created_at).toLocaleString();
              tr.innerHTML = `
                <td>${row.id}</td>
                <td>${row.name || '-'}</td>
                <td>${row.email}</td>
                <td class="message-cell">${row.message || '-'}</td>
                <td>${date}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        })
        .catch(err => {
          document.getElementById('content').innerHTML = 
            '<div class="error"><h3>Error: ' + err.message + '</h3><p>Please check your credentials and try again.</p></div>';
        });
    }
  </script>
</body>
</html>